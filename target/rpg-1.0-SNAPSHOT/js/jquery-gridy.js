/*!
 * jQuery Gridy - A Grid Plugin
 *
 * Licensed under The MIT License
 *
 * @version        1.0.0
 * @author         Washington Botelho
 * @documentation  wbotelhos.com/gridy
 *
 */
(function(e){var t={init:function(n){return this.each(function(){var r=this,i=e(r).empty();r.opt=e.extend({},e.fn.gridy.defaults,n);r.wrapper=i.data("settings",r.opt).wrap('<div id="'+r.id+'-wrapper" />').parent();r.currentPage=e('<input type="hidden" name="page" value="'+r.opt.page+'" />').insertBefore(r);r.currentSortName=e('<input type="hidden" name="sortName" value="'+r.opt.sortName+'" />').insertBefore(r);r.currentSortOrder=e('<input type="hidden" name="sortOrder" value="'+r.opt.sortOrder+'" />').insertBefore(r);r.isTable=r.opt.style=="table";r.hasColumns=r.opt.columns.length>0;r.hasHeaders=r.opt.headers.length>0||r.hasColumns;r.hasFinds=r.opt.finds.length>0;r.hasRows=r.opt.rowsNumber.length>0;r.myWidth=t.getSize.call(r,r.opt.width);r.myHeight=t.getSize.call(r,r.opt.height);if(r.opt.width){r.wrapper.width(r.myWidth)}if(r.opt.width){i.width(r.myWidth)}if(r.isTable){i.attr("cellspacing",0).parent().addClass(r.opt.skin+"-table")}else{i.parent().addClass(r.opt.skin)}t.buildSearcher.call(r);t.buildStatus.call(r);t.buildHeader.call(r);t.buildContent.call(r);t.buildFooter.call(r);t.buildFinder.call(r);t.buildRower.call(r);t.buildRefresher.call(r);t.buildPageButtons.call(r);t.buildMessager.call(r);if(r.opt.firstQuery){t.data.call(r,r.opt.page,r.opt.sortName,r.opt.sortOrder)}else{t.noResult.call(r,r.opt.noFirstQueryText)}})},buildContent:function(){var n=this;if(n.isTable){n.content=e('<tbody class="gridy-content" />')}else{n.content=e('<div class="gridy-content" />');if(n.opt.width){n.content.width(n.myWidth)}if(n.opt.height){n.content.height(n.myHeight)}}n.content.appendTo(n);if(n.opt.scroll){if(!n.opt.height||n.opt.height=="auto"){t.error.call(n,n.id+": height attribute missing!")}if(n.isTable){var r=n.content.parent("table"),i=r.wrap('<div class="gridy-scroll" />').parent("div");if(n.opt.height){i.height(n.myHeight)}if(n.opt.width){i.width(t.getSize.call(n,n.opt.width+15))}var s=r.clone(true).removeAttr("id");s.children("tbody").remove();s.insertBefore(i);r.children("thead").remove()}else{n.content.addClass("gridy-scroll")}}},buildFinder:function(){var n=this;if(n.hasFinds){n.findBox=e('<div class="gridy-find-option"><select></select></div>').appendTo(n.opt.searchOption?n.search.children():n.footer).children();var r=false,i="",s,o;for(var u in n.opt.finds){s=n.opt.finds[u].name;o=n.opt.finds[u].value;if(!s){t.error.call(n,n.id+": finds["+u+"].name missing!")}if(!o){t.error.call(n,n.id+": finds["+u+"].value missing!")}i+='<option value="'+o+'">'+s+"</option>";if(o==n.opt.find){r=true}}if(!r){i='<option value="'+n.opt.find+'" checked="checked">'+n.opt.find+"</option>"+i}n.findBox.html(i).val(n.opt.find).change().change(function(e,t){if(n.opt.searchOption&&n.opt.searchFocus){n.searchField.focus()}}).children('option[value="'+n.opt.find+'"]').attr("checked","checked")}if(n.opt.findTarget){if(!n.hasFinds){t.error.call(n,n.id+": you need set the 'finds' option for find box be created!")}n.findBox.parent().appendTo(n.opt.findTarget)}},buildFooter:function(){var t=this;if(t.hasRows||t.opt.messageOption||!t.opt.searchOption&&t.hasFinds){t.footer=e('<div class="gridy-footer" />').appendTo(t.wrapper);if(t.opt.resize&&t.opt.width){t.footer.width(t.myWidth)}}},buildHeader:function(){var n=this;if(n.hasHeaders){var r;if(n.isTable){r=e('<thead class="gridy-header"><tr></tr></thead>').appendTo(n).children("tr")}else{r=e('<div class="gridy-header" />').appendTo(n);if(n.opt.resize&&n.opt.width){r.width(n.myWidth)}}if(n.opt.headers<=0){n.opt.headers=n.opt.columns}var i,s,o,u,a,f,l;for(var c in n.opt.headers){i=n.opt.headers[c].name;s=n.opt.headers[c].value;o=n.opt.headers[c].width;u=n.opt.headers[c].clazz;f=e("<a />",{href:"javascript:void(0);"});l=e("<div />");if(i){f.html(i)}if(s){f.attr({id:"sort-by-"+s,name:s});if(i){l.addClass(n.opt.arrowNone)}}else{f.addClass("gridy-no-sort")}if(!i||!s){l.addClass("gridy-arrow-empty")}a=e(n.isTable?"<th />":"<div />").append(f,l);if(o){if(n.isTable){a.attr("width",o)}else{a.width(o)}}if(u){a.addClass(u)}a.appendTo(r)}n.sorters=r.children().children("a").click(function(){t.sort.call(n,e(this))});var h=n.sorters.filter("#sort-by-"+n.opt.sortName);if(h.length){t.flick.call(n,h,n.opt.sortOrder,undefined)}}},buildMessager:function(){var t=this;if(t.opt.messageOption){t.messager=e('<div class="gridy-message" />').appendTo(t.footer)}},buildPageButtons:function(){var t=this;if(t.opt.buttonOption){var n=e('<div class="gridy-buttons"><div class="gridy-buttons-content"></div></div>').appendTo(t.wrapper);if(t.opt.resize&&t.opt.width){n.width(t.myWidth)}t.pageButtons=n.children()}},buildRefresher:function(){var n=this;if(n.opt.refreshOption){n.refresher=e('<input type="button" class="'+n.opt.refreshIcon+'" />').click(function(){t.data.call(n,n.currentPage.val(),n.currentSortName.val(),n.currentSortOrder.val())})}if(n.opt.refreshTarget){if(!n.opt.refreshOption){t.error.call(n,n.id+": you must turn the 'refreshOption' to true to use 'refreshTarget'!")}n.refresher.appendTo(n.opt.refreshTarget)}else{n.refresher.appendTo(n.footer)}},buildRower:function(){var n=this;if(n.hasRows){n.rower=e('<div class="gridy-row-option"><select></select></div>').children();var r=n.opt.rows<1?1:n.opt.rows,i=false,s="",o;for(var u in n.opt.rowsNumber){o=n.opt.rowsNumber[u];if(o==r){i=true}s+='<option value="'+o+'">'+t.getNumber.call(n,o)+"</option>"}if(!i){s='<option value="'+r+'" checked="checked">'+t.getNumber.call(n,r)+"</option>"+s}n.rower.html(s).val(r).change().change(function(r,i){t.data.call(n,1,n.currentSortName.val(),n.currentSortOrder.val(),e(n))}).children('option[value="'+r+'"]').attr("checked","checked")}if(n.opt.rowsTarget){if(!n.hasRows){t.error.call(n,n.id+": you need set the 'rowsNumber' option for rows box be created!")}n.rower.parent().appendTo(n.opt.rowsTarget)}else{n.rower.parent().appendTo(n.footer)}},buildSearcher:function(){var n=this;if(n.opt.searchOption){n.search=e('<div class="gridy-search"><div class="gridy-search-content"></div></div>');if(n.opt.resize&&n.opt.width){n.search.width(n.myWidth)}var r=n.search.children();n.searchField=e('<input type="text" name="search" value="'+(n.opt.search==""?n.opt.searchText:n.opt.search)+'" title="'+n.opt.searchText+'" size="40" />').appendTo(r);n.searchField.blur(function(){if(n.searchField.val()==""){n.searchField.removeClass("gridy-typed").val(n.opt.searchText)}}).focus(function(){if(n.searchField.val()==n.opt.searchText){n.searchField.addClass("gridy-typed").val("")}}).keypress(function(e){if((e.keyCode?e.keyCode:e.which)==13){t.data.call(n,1,n.currentSortName.val(),n.currentSortOrder.val())}});n.searchButton=e('<input type="button" value="'+n.opt.searchButtonLabel+'" title="'+n.opt.searchButtonTitle+'" />').click(function(){t.data.call(n,1,n.currentSortName.val(),n.currentSortOrder.val())}).appendTo(r);if(n.opt.searchTarget){n.search.appendTo(n.opt.searchTarget)}else{n.search.insertBefore(e(n))}}},buildStatus:function(){var t=this;if(t.opt.loadingOption||t.opt.statusOption){t.statusBox=e('<div class="gridy-status" />').insertBefore(e(t));if(t.opt.resize&&t.opt.width){t.statusBox.width(t.myWidth)}}if(t.opt.loadingOption){t.loading=e('<div class="'+t.opt.loadingIcon+'"><div>'+t.opt.loadingText+"</div></div>").appendTo(t.statusBox).children().hide()}if(t.opt.statusOption){t.result=e('<div class="gridy-result" />').appendTo(t.statusBox)}},data:function(n,r,i){var s=this;t.enableGrid.call(s,false);t.loading.call(s,true);if(s.opt.before){var o=s.opt.before.call(s,n,r,i);if(o){if(o.page){n=o.page}if(o.sortName){r=o.sortName}if(o.sortOrder){i=o.sortOrder}}}var u=s.opt.search,a=s.hasRows?s.rower.val():s.opt.rows,f=s.hasFinds?s.findBox.val():s.opt.find;if(s.opt.searchOption){u=s.searchField.val()==s.opt.searchText?"":s.searchField.val();if(s.opt.searchFocus){s.searchField.focus()}}if(s.opt.data){t.process.call(s,s.opt.data,n,r,i);return}var l={search:u,page:n,sortName:r,sortOrder:i,find:f,rows:a};for(var c in s.opt.params){l[c]=s.opt.params[c]}for(var c in s.opt.paramsElements){var h=s.opt.paramsElements[c];e(h).each(function(t){var n=e(this);if(n.is(":enabled")&&!n.is(":checkbox")||n.is(":checked")){if(h.indexOf(".")==0){var r=l[this.name],i=[];if(r){for(var t in r){i.push(r[t])}}i.push(this.value);l[this.name]=i}else{l[this.name]=this.value}}})}if(s.opt.debug){var p="[debug] query string:\n\n";for(var c in l){p+=c;for(var d=0;d<20-c.length;d++){p+=" "}p+=": "+(l[c]||"''")+"\n"}if(window.console&&window.console.log){window.console.log(p)}}e.ajax({cache:s.opt.cache,contentType:s.opt.contentType,dataType:s.opt.dataType,jsonp:s.opt.jsonp,jsonpCallback:s.opt.jsonpCallback,type:s.opt.type,url:s.opt.url,data:l,success:function(o,u,f){t.process.call(s,o,n,r,i,a);if(s.opt.hoverFx){s.content.children(':not("p")').mouseenter(function(){e(this).addClass("gridy-row-hovered")}).mouseleave(function(){e(this).removeClass("gridy-row-hovered")})}if(s.opt.clickFx){s.content.children(':not("p")').click(function(t){var n=e(this);if(!t.ctrlKey&&!t.metaKey){n.parent().children(".gridy-row-selected").removeClass("gridy-row-selected")}n.toggleClass("gridy-row-selected")})}if(s.opt.done){s.opt.done.call(s,o,u,f)}},error:function(e,n,r){t.message.call(s,t.getError.call(s,e));if(s.opt.fail){s.opt.fail.call(s,e,n,r)}},complete:function(e,n){t.loading.call(s,false);t.enableGrid.call(s,true);if(s.opt.scroll){if(s.isTable){s.content.children(":first").addClass("gridy-first-line")}else{s.content.children(":last").addClass("gridy-last-line")}}else{if(s.isTable){s.content.children("tr:last").children("td").addClass("gridy-last-line")}if(s.opt.separate){var r=s.content.children(":first");if(s.isTable){r=r.children("td")}r.addClass("gridy-separate")}}if(s.opt.always){s.opt.always.call(s,e,n)}}})},enableGrid:function(n){var r=this;if(n){if(r.opt.searchOption){r.searchField.removeAttr("readonly");r.searchButton.removeAttr("disabled")}if(r.hasHeaders){r.sorters.filter(':not(".gridy-no-sort")').click(function(){t.sort.call(r,e(this))})}if(r.opt.buttonOption){r.pageButtons.children(':not(".gridy-button-reticence")').removeAttr("disabled")}if(r.hasFinds){r.findBox.removeAttr("disabled")}if(r.hasRows){r.rower.removeAttr("disabled")}if(r.opt.refreshOption){r.refresher.removeAttr("disabled")}}else{if(r.opt.searchOption){r.searchField.attr("readonly","readonly");r.searchButton.attr("disabled","disabled")}if(r.hasHeaders){r.sorters.unbind("click")}if(r.opt.buttonOption){r.pageButtons.attr("disabled","disabled")}if(r.hasFinds){r.findBox.attr("disabled","disabled")}if(r.hasRows){r.rower.attr("disabled","disabled")}if(r.opt.refreshOption){r.refresher.attr("disabled","disabled")}}},error:function(t){this.wrapper.html('<div class="gridy-error">'+t+"</div>");e.error(t)},flick:function(e,t,n){var r=this,i=t=="asc"?r.opt.arrowUp:r.opt.arrowDown;if(n){n.removeAttr("rel").removeClass("gridy-sorted").next("div").removeClass().addClass(r.opt.arrowNone)}e.attr("rel",t).addClass("gridy-sorted").next("div").removeClass().addClass(i)},getError:function(e){return e.responseText?e.responseText.substring(e.responseText.indexOf("(")+1,e.responseText.indexOf(")")):e.statusText},getNumber:function(e){return e<10?"0"+e:e},getSize:function(e){return isNaN(parseInt(e,10))?e:e+"px"},loading:function(e){var t=this;if(t.opt.loadingOption){if(e){t.loading.fadeIn("fast");t.content.children().children().addClass("gridy-fade")}else{t.loading.fadeOut();t.content.children().children().removeClass("gridy-fade")}}},message:function(e){var t=this;if(t.opt.messageOption){t.messager.html(e).show();setTimeout(function(){t.messager.fadeOut(function(){t.messager.hide().empty()})},t.opt.messageTimer)}},noResult:function(e){var t=this;if(t.opt.resultOption){t.content.html('<p class="gridy-no-result">'+(e||"")+"</p>");if(t.opt.statusOption){t.result.html(t.result.html().replace(/\d+/g,"0"))}if(t.opt.searchOption){t.searchField.focus().select()}}},process:function(n,r,i,s,o){var u=this;if(typeof n=="string"){n=e.parseJSON(n)}if(u.opt.filter){var a=u.opt.filter.call(u,n,r,i,s);if(a){n=a;if(typeof n=="string"){n=e.parseJSON(n)}}}var f=u.opt.totalPath.split("."),l=0,c;for(var h in f){c=f[h];l=h==0?n[c]:l[c]}if(l==0){t.noResult.call(u,u.opt.noResultText);if(u.opt.buttonOption){u.pageButtons.empty()}return}var p=u.opt.listPath.split("."),d=[];for(var h in p){c=p[h];d=h==0?n[c]:d[c]}u.content.html(e("#"+u.opt.template).tmpl(d));if(u.opt.evenOdd){u.content.children(":even").addClass(u.opt.scroll?"gridy-even":"gridy-even").end().children(":odd").addClass(u.opt.scroll?"gridy-odd":"gridy-odd")}var v;u.content.children().each(function(){e(this).children().each(function(t){if(u.opt.columns[t]){v=u.opt.columns[t].width;if(u.isTable){e(this).attr("width",v)}else{e(this).width(v)}}})});var m=l%o,g=(l-m)/o;if(m>0){g++}if(u.opt.statusOption){var y=u.opt.statusText.replace("{from}",t.getNumber.call(u,r)).replace("{to}",t.getNumber.call(u,g)).replace("{total}",t.getNumber.call(u,l));u.result.html(y)}if(u.opt.buttonOption){if(l>o){var b='<input type="button" value="..." disabled="disabled" class="gridy-button-reticence"/>&#160;',w="",E=0,S=undefined,x=1,T=u.opt.buttonMax,N=T%2==0;if(T>g){T=g}if(N){S=Math.ceil(T/2);x=r-S+1}else{S=Math.floor(T/2);x=r-S}var C=parseInt(r,10)+S;if(x==0){C++;x=1}if(x<0){C+=Math.abs(x)+1;x=1}if(C>g){if(x>1){if(x===C-g){x=1}else{x-=C-g}}C=g}var k=g>T,L=k&&r>(N?S:S+1),A=k&&r<g-S;if(L){w='<input type="button" value="‹‹" alt="'+1+'" title="'+u.opt.buttonFirstTitle+'"/>&#160;';w+='<input type="button" value="‹" alt="'+u.opt.buttonBackTitle+'" title="'+u.opt.buttonBackTitle+'" class="gridy-back"/>&#160;';w+=b}for(var h=x;h<=C;h++){E=t.getNumber.call(u,h);w+='<input type="button" value="'+E+'" alt="'+E+'" title="'+u.opt.buttonTitle+" "+E+'"/>&#160;'}if(A){w+=b;w+='<input type="button" value="›" alt="'+u.opt.buttonNextTitle+'" title="'+u.opt.buttonNextTitle+'" class="gridy-next"/>&#160;';w+='<input type="button" value="››" alt="'+g+'" title="'+u.opt.buttonLastTitle+'"/>&#160;'}var O=u.pageButtons.html(w).children('input:button:not(".gridy-back, .gridy-reticence, .gridy-next")');O.click(function(){t.data.call(u,parseInt(this.alt,10),u.currentSortName.val(),u.currentSortOrder.val())}).filter('[value="'+t.getNumber.call(u,r)+'"]').attr("disabled","disabled").addClass("gridy-button-active");if(L){u.pageButtons.children(".gridy-back").click(function(){t.data.call(u,r-1,u.currentSortName.val(),u.currentSortOrder.val())})}if(A){u.pageButtons.children(".gridy-next").click(function(){t.data.call(u,r+1,u.currentSortName.val(),u.currentSortOrder.val())})}}else{u.pageButtons.empty()}}u.currentPage.val(r);u.currentSortName.val(i);u.currentSortOrder.val(s)},reload:function(){return t.set.call(this,{})},set:function(t){return this.each(function(){var n=e(this),r=n.data("settings"),i=n.parent();if(r.scroll&&r.style=="table"){i=i.parent()}n.insertBefore(i);i.remove();n.gridy(e.extend({},r,t))})},sort:function(e){var n=this,r=e.attr("name"),i=e.attr("rel"),s=i&&i=="asc"?"desc":"asc",o=n.sorters.filter(".gridy-sorted");t.flick.call(n,e,s,o);t.data.call(n,n.currentPage.val(),r,s)}};e.fn.gridy=function(n){if(t[n]){return t[n].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof n==="object"||!n){return t.init.apply(this,arguments)}else{e.error("Method "+n+" does not exist!")}};e.fn.gridy.defaults={always:undefined,cache:undefined,contentType:undefined,dataType:"json",done:undefined,fail:undefined,jsonp:undefined,jsonpCallback:undefined,page:1,params:{},paramsElements:[],sortName:"",sortOrder:"asc",type:"get",url:"/gridy",before:undefined,filter:undefined,columns:[],height:undefined,scroll:false,style:"table",width:undefined,evenOdd:false,resize:true,separate:true,skin:"gridy",clickFx:false,hoverFx:false,find:"",finds:[],findTarget:undefined,arrowDown:"gridy-arrow-down",arrowNone:"gridy-arrow-none",arrowUp:"gridy-arrow-up",headers:[],buttonBackTitle:"‹ Back",buttonFirstTitle:"‹ First",buttonMax:10,buttonNextTitle:"Next ›",buttonLastTitle:"Last ›",buttonOption:true,buttonTitle:"Page",listPath:"list",totalPath:"total",template:"template",loadingIcon:"gridy-loading",loadingOption:true,loadingText:"Loading...",messageOption:true,messageTimer:4e3,debug:false,refreshIcon:"gridy-button-refresh",refreshOption:true,refreshTarget:undefined,firstQuery:true,noFirstQueryText:"No search was performed yet!",noResultText:"No item was found!",resultOption:true,rows:10,rowsNumber:[5,10,25,50,100],rowsTarget:undefined,search:"",searchButtonLabel:"search",searchButtonTitle:"Start the search",searchFocus:true,searchOption:true,searchTarget:undefined,searchText:"",statusOption:true,statusText:"Displaying {from} - {to} of {total} items"}})(jQuery)